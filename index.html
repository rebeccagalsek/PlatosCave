<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="style.css">
	<title>Canvas and Typing Response Box Example</title>
	<style>
		canvas {
			border: 1px solid #000;
		}
		.submission-img {
			max-width: 400px;
			max-height: 400px;
		}
	</style>
</head>
<body>
	<h1>Canvas and Typing Response Box Example</h1>

	<h2>Canvas</h2>
	<canvas id="canvas" width="400" height="400"></canvas>

	<button id="submit">Done</button>

	<h2>Previous Submissions</h2>
	<div id="submissions-container"></div>

	<script>
		const canvas = document.getElementById('canvas');
		const ctx = canvas.getContext('2d');
		let isDrawing = false;

		canvas.addEventListener('mousedown', start);
		canvas.addEventListener('mousemove', draw);
		canvas.addEventListener('mouseup', stop);

		function start(e) {
			isDrawing = true;
			draw(e);
		}

		function draw(e) {
			if (!isDrawing) return;
			ctx.lineWidth = 10;
			ctx.lineCap = 'round';
			ctx.strokeStyle = '#000';
			ctx.lineTo(e.offsetX, e.offsetY);
			ctx.stroke();
			ctx.beginPath();
			ctx.moveTo(e.offsetX, e.offsetY);
		}

		function stop() {
			isDrawing = false;
			ctx.beginPath();
		}

		const responseBox = document.getElementById('response');
		const submitBtn = document.getElementById('submit');
		let response;

		submitBtn.addEventListener('click', () => {
			response = responseBox.value;
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			responseBox.value = "";
			alert("Response submitted!");
			saveSubmission();
		});

		window.onload = function() {
			if (localStorage.getItem('prevResponse')) {
				responseBox.placeholder = "Last response was: " + localStorage.getItem('prevResponse');
			}
			loadSubmissions();
		};

		window.onbeforeunload = function() {
			localStorage.setItem('prevResponse', response);
		};

		function saveSubmission() {
			let image = canvas.toDataURL();
			let data = {
				'response': response,
				'image': image
			};
			fetch('/submit-image', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data)
			})
			.then(response => response.json())
			.then(data => console.log(data))
			.catch(error => console.error(error));
		}

		function loadSubmissions() {
			fetch('/get-submissions')
			.then(response => response.json())
			.then(data => displaySubmissions(data))
			.catch(error => console.error(error));
		}

		function displaySubmissions(submissions) {
			const submissionsContainer = document.getElementById('submissions-container');
			submissionsContainer.innerHTML = '';
			submissions.forEach(submission => {
				let submissionDiv = document.createElement('div');
				submissionDiv.innerHTML = `
					<p>${submission.filename}</p>
					<img src="/get-image/${submission.filename}" class="submission-img">
				`;
				submissionsContainer.appendChild(submissionDiv);
			});
		}

	</script>
</body>
</html>
